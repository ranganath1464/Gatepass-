<script>
  async function arrayBufferToBase64(buffer) {
    let binary = '';
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary);
  }

  function base64ToArrayBuffer(base64) {
    const binaryString = window.atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
  }

  document.getElementById('startFingerprint').addEventListener('click', async () => {
    try {
      const res = await fetch('/register-passkey-options');
      const options = await res.json();

      // Convert options to correct format
      options.challenge = base64ToArrayBuffer(options.challenge);
      options.user.id = base64ToArrayBuffer(options.user.id);

      const cred = await navigator.credentials.create({ publicKey: options });

      const credentialData = {
        id: cred.id,
        rawId: await arrayBufferToBase64(cred.rawId),
        type: cred.type,
        response: {
          clientDataJSON: await arrayBufferToBase64(cred.response.clientDataJSON),
          attestationObject: await arrayBufferToBase64(cred.response.attestationObject)
        }
      };

      const result = await fetch('/webauthn/register-complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(credentialData)
      });

      if (result.ok) {
        alert("Fingerprint registration successful!");
        window.location.href = "/student/dashboard";
      } else {
        alert("Fingerprint registration failed.");
      }
    } catch (err) {
      console.error(err);
      alert("Biometric not supported, or user cancelled.");
    }
  });

  function skipFingerprint() {
    window.location.href = "/student/dashboard";
  }
</script>
